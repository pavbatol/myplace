<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.29.xsd">

    <changeSet id="1_create-countries_temp-table" author="pavbatol">
        <createTable tableName="countries_temp">
            <column name="name_ru" type="varchar(150)"/>
            <column name="name_en" type="varchar(150)"/>
            <column name="ISO3166_1" type="varchar(10)"/>
            <column name="ISO3166_1_alpha2" type="varchar(10)"/>
            <column name="ISO3166_1_alpha3" type="varchar(10)"/>
            <column name="ISO3166_1_numeric" type="varchar(10)"/>
            <column name="country_code_iso3166_1_alpha_2" type="varchar(10)"/>
            <column name="country_code_fips" type="varchar(10)"/>
            <column name="official_name_ru" type="varchar(150)"/>
            <column name="official_name_en" type="varchar(150)"/>
            <column name="wikipedia" type="varchar(150)"/>
            <column name="longitude" type="varchar(20)"/>
            <column name="latitude" type="varchar(20)"/>
            <column name="id" type="varchar(20)"/>
        </createTable>
    </changeSet>

    <changeSet id="2_load_data_to_countries_temp_pgsql" author="pavbatol">
        <preConditions onFail="MARK_RAN">
            <dbms type="postgresql"/>
        </preConditions>
        <sql>
            COPY countries_temp
            FROM './mp-profile/src/main/resources/db/data/countries/countries-all.csv'
            DELIMITER ','
            CSV HEADER;
        </sql>
    </changeSet>

    <changeSet id="2.1_load_data_to_countries_temp_h2" author="pavbatol">
        <preConditions onFail="MARK_RAN">
            <dbms type="h2"/>
        </preConditions>
        <sql>
            INSERT INTO countries_temp
            SELECT *
            FROM
            CSVREAD('./mp-profile/src/main/resources/db/data/countries/countries-all.csv', ',', 'IGNORE 1');
        </sql>
    </changeSet>

    <changeSet id="3_insert_data_to_countries_pgsql" author="pavbatol">
        <preConditions onFail="MARK_RAN">
            <dbms type="postgresql"/>
        </preConditions>
        <sql>
            INSERT INTO countries (code, name)
            SELECT
            COALESCE(country_code_iso3166_1_alpha_2, ISO3166_1_alpha2) AS country_code,
            COALESCE(name_ru, official_name_ru, name_en, official_name_en) AS country_name
            FROM countries_temp
            WHERE
            COALESCE(country_code_iso3166_1_alpha_2, ISO3166_1_alpha2) IS NOT NULL
            AND
            COALESCE(name_ru, official_name_ru, name_en, official_name_en) IS NOT NULL
            ON CONFLICT (code) DO NOTHING;
        </sql>
    </changeSet>

    <changeSet id="3.1_insert_data_to_countries_h2" author="pavbatol">
        <preConditions onFail="MARK_RAN">
            <dbms type="h2"/>
        </preConditions>
        <sql>
            MERGE INTO countries AS target
            USING (
            SELECT
            COALESCE(country_code_iso3166_1_alpha_2, ISO3166_1_alpha2) AS country_code,
            COALESCE(name_ru, official_name_ru, name_en, official_name_en) AS country_name
            FROM countries_temp
            WHERE
            COALESCE(country_code_iso3166_1_alpha_2, ISO3166_1_alpha2) IS NOT NULL
            AND
            COALESCE(name_ru, official_name_ru, name_en, official_name_en) IS NOT NULL
            ) AS source
            ON target.code = source.country_code
            WHEN NOT MATCHED THEN
            INSERT (code, name) VALUES (source.country_code, source.country_name)
        </sql>
    </changeSet>

    <changeSet id="4_drop_temp_country_table" author="your_name">
        <dropTable tableName="countries_temp"/>
    </changeSet>

</databaseChangeLog>
